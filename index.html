<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé¨ Movie Finder</title>
  <meta name="description" content="Search for movies with OMDb API: title, poster, year, IMDb rating, and short plot." />
  <style>
    /* same CSS as before */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand" aria-label="Movie Finder">
        <div class="logo">üé¨</div>
        <span>Movie Finder</span>
      </div>

      <div class="controls" role="search">
        <div class="searchbar">
          <input id="query" type="search" placeholder="Search movies‚Ä¶ (e.g., Inception)" aria-label="Search movies" />
          <button class="btn" id="searchBtn" aria-label="Search">Search</button>
        </div>

        <div class="theme-toggle">
          <button id="themeBtn" class="secondary" aria-label="Toggle light/dark">üåô</button>
        </div>
      </div>
    </header>

    <main>
      <div id="status" class="status">Enter a title and hit Search.</div>

      <section id="results" class="results-grid" aria-live="polite" aria-busy="false"></section>

      <div class="load-more">
        <button id="loadMoreBtn" class="btn secondary" hidden>Load more</button>
      </div>

      <p class="footer-note">Shows title, poster, year, IMDb rating, and a short plot using the OMDb API.</p>
    </main>
  </div>

  <script>
    const $ = (s, root=document) => root.querySelector(s);

    // --- Hard-coded API key ---
    const OMDB_API_KEY = "c6693d25"; // üëà Replace with your OMDb API key

    const STORAGE = { theme: 'moviefinder:theme', lastQuery: 'moviefinder:last-query' };

    // --- Theme ---
    function applyTheme(theme){
      if(theme === 'light') document.body.classList.add('light');
      else document.body.classList.remove('light');
      $('#themeBtn').textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem(STORAGE.theme, theme);
    }

    (function initTheme(){
      const stored = localStorage.getItem(STORAGE.theme);
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(stored || (prefersLight ? 'light' : 'dark'));
    })();

    $('#themeBtn').addEventListener('click', () => {
      const now = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(now);
    });

    // --- Search logic ---
    const resultsEl = $('#results');
    const statusEl = $('#status');
    const loadMoreBtn = $('#loadMoreBtn');

    let currentQuery = '';
    let currentPage = 1;
    let totalResults = 0;
    let abortController = null;

    function flashStatus(msg){
      statusEl.textContent = msg;
      statusEl.hidden = false;
    }

    function setBusy(busy){
      if(busy){
        statusEl.innerHTML = '<span class="spinner" aria-hidden="true">‚è≥</span> Loading‚Ä¶';
        statusEl.hidden = false;
        $('#results').setAttribute('aria-busy','true');
      } else {
        $('#results').setAttribute('aria-busy','false');
      }
    }

    async function search(query, page=1){
      const key = OMDB_API_KEY;
      if(!key){
        flashStatus('Please add your OMDb API key in the code.');
        return;
      }

      if(abortController) abortController.abort();
      abortController = new AbortController();

      setBusy(true);
      loadMoreBtn.hidden = true;
      try{
        const sUrl = new URL('https://www.omdbapi.com/');
        sUrl.search = new URLSearchParams({ apikey:key, s:query, type:'movie', page:String(page) }).toString();
        const sRes = await fetch(sUrl, { signal: abortController.signal });
        const sData = await sRes.json();

        if(sData.Response === 'False'){
          if(page === 1) resultsEl.innerHTML = '';
          flashStatus(sData.Error || 'No results.');
          setBusy(false);
          return;
        }

        totalResults = parseInt(sData.totalResults || '0', 10);
        if(page === 1){
          resultsEl.innerHTML = '';
          statusEl.hidden = true;
        }

        const items = sData.Search;
        const details = await Promise.all(items.map(async (it) => {
          try{
            const dUrl = new URL('https://www.omdbapi.com/');
            dUrl.search = new URLSearchParams({ apikey:key, i:it.imdbID, plot:'short' }).toString();
            const r = await fetch(dUrl, { signal: abortController.signal });
            const j = await r.json();
            return j;
          }catch(err){ return it; }
        }));

        for(const d of details){
          resultsEl.appendChild(renderCard(d));
        }

        const shown = resultsEl.children.length;
        const moreAvailable = shown < totalResults;
        loadMoreBtn.hidden = !moreAvailable;
        loadMoreBtn.disabled = !moreAvailable;
        setBusy(false);
      }catch(err){
        if(err.name === 'AbortError') return;
        flashStatus('Something went wrong. Check your connection or API key.');
        setBusy(false);
      }
    }

    function renderCard(d){
      const poster = (d.Poster && d.Poster !== 'N/A') ? d.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 300 450%22%3E%3Crect width=%22300%22 height=%22450%22 fill=%22%23161625%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23b7b9c9%22 font-family=%22Arial%22 font-size=%2230%22%3ENo Poster%3C/text%3E%3C/svg%3E';
      const title = d.Title || 'Untitled';
      const year = d.Year || '‚Äî';
      const imdb = (d.imdbRating && d.imdbRating !== 'N/A') ? `‚≠ê ${d.imdbRating}` : '‚≠ê ‚Äî';
      const plot = (d.Plot && d.Plot !== 'N/A') ? d.Plot : 'Plot unavailable.';

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <img class="poster" alt="Poster for ${title}" loading="lazy" src="${poster}">
        <div class="card-content">
          <div class="title">${title}</div>
          <div class="meta">${year}</div>
          <div class="rating">${imdb}</div>
          <div class="plot">${plot}</div>
        </div>
      `;
      return card;
    }

    $('#searchBtn').addEventListener('click', () => {
      const q = $('#query').value.trim();
      if(!q) return flashStatus('Type a movie title to search.');
      currentQuery = q; currentPage = 1; localStorage.setItem(STORAGE.lastQuery, q);
      search(currentQuery, currentPage);
    });

    $('#query').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') $('#searchBtn').click();
    });

    loadMoreBtn.addEventListener('click', () => {
      currentPage += 1; search(currentQuery, currentPage);
    });

    (function restore(){
      const last = localStorage.getItem(STORAGE.lastQuery);
      if(last){ $('#query').value = last; }
    })();
  </script>
</body>
</html>
